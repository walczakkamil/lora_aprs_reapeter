name: Build Custom APRS Firmware

on:
  workflow_dispatch:
    inputs:
      callsign:
        description: 'Callsign (np. SP7FM-1)'
        required: true
        default: 'N0CALL-1'
      rx_freq:
        description: 'RX Frequency (Hz)'
        required: true
        default: '434855000'
      tx_freq:
        description: 'TX Frequency (Hz)'
        required: true
        default: '434955000'
      coordinates:
        description: 'GPS coordinates APRS (np. !5144.22N/01934.44E)'
        required: true
        default: '!5144.22N/01934.44E'
      lora_sf:
        description: 'Spreading Factor'
        required: false
        default: '9'
      lora_bw_idx:
        description: 'Signal Bandwidth'
        required: false
        default: '7'
      lora_cr:
        description: 'Coding Rate'
        required: false
        default: '3'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ARM GCC Toolchain (System Package)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi
          arm-none-eabi-gcc --version

      - name: Update Configuration (Apply User Inputs)
        run: |
          sed -i 's/#define LORA_RX_FREQ.*/#define LORA_RX_FREQ    ${{ inputs.rx_freq }}/' STM32/Core/Src/main.c
          sed -i 's/#define LORA_TX_FREQ.*/#define LORA_TX_FREQ    ${{ inputs.tx_freq }}/' STM32/Core/Src/main.c
          sed -i 's|#define APRS_CALLSIGN.*|#define APRS_CALLSIGN "${{ inputs.callsign }}"|' STM32/Core/Src/main.c
          sed -i 's|#define APRS_COORDS.*|#define APRS_COORDS     "${{ inputs.coordinates }}"|' STM32/Core/Src/main.c
          sed -i 's|#define LORA_SF.*|#define LORA_SF             ${{ inputs.lora_sf }}|' STM32/Core/Src/main.c
          sed -i 's|#define LORA_BW_IDX.*|#define LORA_BW_IDX     ${{ inputs.lora_bw_idx }}|' STM32/Core/Src/main.c
          sed -i 's|#define LORA_CR.*|#define LORA_CR             ${{ inputs.lora_cr }}|' STM32/Core/Src/main.c
          
          echo "Updated main.c from input:"
          grep "#define LORA_RX_FREQ" STM32/Core/Src/main.c
          grep "#define LORA_TX_FREQ" STM32/Core/Src/main.c
          grep "#define APRS_CALLSIGN" STM32/Core/Src/main.c
          grep "#define APRS_COORDS" STM32/Core/Src/main.c
          grep "#define LORA_SF" STM32/Core/Src/main.c
          grep "#define LORA_BW_IDX" STM32/Core/Src/main.c
          grep "#define LORA_CR" STM32/Core/Src/main.c

      - name: Fix Makefile Absolute Paths
        run: |
          sed -i 's|C:.*STM32F103C8TX_FLASH.ld|../STM32F103C8TX_FLASH.ld|g' STM32/Debug/makefile
          echo "Makefile path to linker: "
          grep "STM32F103C8TX_FLASH.ld" STM32/Debug/makefile

      - name: Build Firmware
        run: |
          make -C STM32/Debug -j4 all

      - name: Rename Binary
        run: |
          mv STM32/Debug/Lora_APRS_repeater.elf Lora_APRS_repeater_${{ inputs.callsign }}.elf

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ inputs.callsign }}
          path: |
            Lora_APRS_repeater_${{ inputs.callsign }}.elf

